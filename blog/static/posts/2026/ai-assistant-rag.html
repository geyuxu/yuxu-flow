<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Building a RAG-Powered AI Assistant for My Personal Website | Yuxu Ge</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <style>
        :root {
            --black: #111;
            --dark-grey: #444;
            --off-white: #f4f4f4;
            --vermilion: #C41E3A;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: var(--black);
            background-color: var(--off-white);
        }

        a {
            color: var(--vermilion);
            text-decoration: none;
        }

        a:hover {
            opacity: 0.75;
        }

        .layout {
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 320px;
            height: 100vh;
            background: var(--black);
            color: var(--off-white);
            padding: 3rem 2rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .sidebar-top {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .avatar {
            display: block;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid var(--vermilion);
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: transform 0.2s ease;
        }

        .avatar:hover {
            opacity: 1;
            transform: scale(1.05);
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .name-block {
            margin-bottom: 0.5rem;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 1px;
            color: var(--off-white);
        }

        .title-role {
            font-size: 0.9rem;
            color: #888;
            margin-top: 0.25rem;
            font-weight: 400;
        }

        .contact-block {
            margin-top: 2.5rem;
            width: 100%;
        }

        .social-links {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }

        .social-links a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 160px;
            color: var(--off-white);
            opacity: 0.7;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .social-links a:hover {
            color: var(--vermilion);
            opacity: 1;
            background: rgba(255, 255, 255, 0.05);
        }

        .social-links svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .social-links .orcid-link {
            font-size: 0.68rem;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .sidebar-footer {
            text-align: center;
            font-size: 0.75rem;
            color: #555;
        }

        /* Content */
        .content {
            margin-left: 320px;
            padding: 3rem 4rem;
            max-width: 900px;
        }

        .back-link {
            display: inline-block;
            font-size: 0.85rem;
            margin-bottom: 2rem;
            color: var(--dark-grey);
        }

        .back-link:hover {
            color: var(--vermilion);
        }

        /* Article */
        article h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            line-height: 1.3;
            color: var(--black);
        }

        article h2 {
            font-size: 1.4rem;
            font-weight: 600;
            margin: 2rem 0 1rem;
            color: var(--black);
        }

        article h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 1.5rem 0 0.75rem;
            color: var(--black);
        }

        article p {
            margin-bottom: 1rem;
            color: var(--dark-grey);
        }

        article ul,
        article ol {
            margin: 1rem 0 1rem 1.5rem;
            color: var(--dark-grey);
        }

        article li {
            margin-bottom: 0.5rem;
        }

        article strong {
            color: var(--black);
        }

        article code {
            font-family: "SF Mono", Monaco, monospace;
            font-size: 0.9em;
            background: #e8e8e8;
            padding: 0.15em 0.4em;
            border-radius: 3px;
        }

        article pre {
            margin: 1rem 0;
            border-radius: 6px;
            overflow-x: auto;
            background: #2d2d2d;
            padding: 1rem;
        }

        article pre code {
            background: none;
            padding: 0;
            font-size: 0.75em;
            white-space: pre !important;
            counter-reset: line;
            display: block;
            color: #ccc;
        }

        article pre code .line {
            counter-increment: line;
        }

        article pre code .line::before {
            content: counter(line);
            display: inline-block;
            width: 2.5em;
            margin-right: 1em;
            text-align: right;
            color: #666;
            user-select: none;
        }

        .code-toolbar {
            display: flex;
            justify-content: flex-start;
            padding: 0.35rem 0.5rem;
            background: #3a3a3a;
            border-radius: 6px 6px 0 0;
        }

        .code-toolbar+pre {
            margin-top: 0;
            border-radius: 0 0 6px 6px;
        }

        .copy-btn {
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
            background: #555;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover,
        .copy-btn:active {
            background: #777;
        }

        .copy-btn.copied {
            background: #2a2;
        }

        article blockquote {
            border-left: 3px solid var(--vermilion);
            padding-left: 1rem;
            margin: 1rem 0;
            color: #666;
            font-style: italic;
        }

        article hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 2rem 0;
        }

        article table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.9rem;
        }

        article th,
        article td {
            border: 1px solid #ddd;
            padding: 0.5rem 0.75rem;
            text-align: left;
        }

        article th {
            background: #e8e8e8;
            font-weight: 600;
        }

        article img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 1.5rem 0;
            border-radius: 6px;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #888;
        }

        .error {
            color: var(--vermilion);
        }

        /* Language Selector */
        .lang-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            padding: 0.75rem 1rem;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .lang-selector-label {
            color: #666;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .lang-selector-label svg {
            width: 16px;
            height: 16px;
        }

        .lang-select {
            padding: 0.4rem 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 0.85rem;
            cursor: pointer;
            min-width: 140px;
        }

        .lang-select:focus {
            outline: none;
            border-color: var(--vermilion);
        }

        .lang-status {
            font-size: 0.8rem;
            color: #888;
            margin-left: auto;
        }

        .lang-status.translating {
            color: var(--vermilion);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .lang-status.translating::before {
            content: '';
            width: 14px;
            height: 14px;
            border: 2px solid #f0f0f0;
            border-top-color: var(--vermilion);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .lang-status.cached {
            color: #4CAF50;
        }

        .lang-original-btn {
            padding: 0.35rem 0.6rem;
            font-size: 0.75rem;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            color: #666;
            transition: all 0.2s;
        }

        .lang-original-btn:hover {
            background: #e0e0e0;
            color: #333;
        }

        @media (max-width: 600px) {
            .lang-selector {
                flex-wrap: wrap;
            }
            .lang-status {
                width: 100%;
                margin-left: 0;
                margin-top: 0.5rem;
            }
        }

        /* KaTeX math styles */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: 0.5rem 0;
        }

        .katex {
            font-size: 1.1em;
        }

        /* Jupyter Notebook Styles */
        .notebook-container {
            margin-top: 1rem;
        }

        .notebook-download {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            margin-bottom: 1.5rem;
            background: var(--black);
            color: var(--off-white);
            border-radius: 4px;
            font-size: 0.85rem;
            transition: opacity 0.2s;
        }

        .notebook-download:hover {
            opacity: 0.8;
            color: var(--off-white);
        }

        .notebook-download svg {
            width: 16px;
            height: 16px;
        }

        .nb-cell {
            margin-bottom: 1.5rem;
        }

        .nb-cell-code .nb-source {
            background: #2d2d2d;
            border-radius: 6px;
            overflow-x: auto;
        }

        .nb-cell-code .nb-source pre {
            margin: 0;
            padding: 1rem;
            color: #ccc;
            font-family: "SF Mono", Monaco, monospace;
            font-size: 0.85em;
        }

        .nb-cell-code .nb-source code {
            background: none;
            padding: 0;
        }

        .nb-output {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 0.5rem;
        }

        .nb-output pre {
            margin: 0;
            padding: 0;
            background: transparent;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: "SF Mono", Monaco, monospace;
            font-size: 0.85em;
            color: #222;
        }

        .nb-output img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0.5rem 0;
        }

        .nb-output table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .nb-output th,
        .nb-output td {
            border: 1px solid #ddd;
            padding: 0.5rem;
            text-align: left;
        }

        .nb-output th {
            background: #e8e8e8;
            font-weight: 600;
        }

        .nb-cell-markdown {
            padding: 0;
        }

        .nb-cell-markdown h1:first-child {
            margin-top: 0;
        }

        /* Document Download Button */
        .doc-download {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            margin-bottom: 1.5rem;
            background: var(--black);
            color: var(--off-white);
            border-radius: 4px;
            font-size: 0.85rem;
            transition: opacity 0.2s;
        }

        .doc-download:hover {
            opacity: 0.8;
            color: var(--off-white);
        }

        .doc-download svg {
            width: 16px;
            height: 16px;
        }

        /* PDF Viewer */
        .pdf-container {
            margin-top: 1rem;
        }

        .pdf-viewer {
            width: 100%;
            height: 80vh;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #f5f5f5;
        }

        /* Text File Display */
        .text-container {
            margin-top: 1rem;
        }

        .text-content {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 1.5rem;
            font-family: "SF Mono", Monaco, monospace;
            font-size: 0.9em;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: var(--dark-grey);
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Word Document Display */
        .word-container {
            margin-top: 1rem;
        }

        .word-content {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 2rem;
            line-height: 1.8;
            color: var(--dark-grey);
        }

        .word-content p {
            margin-bottom: 1rem;
        }

        .word-content h1,
        .word-content h2,
        .word-content h3 {
            color: var(--black);
            margin: 1.5rem 0 1rem;
        }

        .word-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        .word-content th,
        .word-content td {
            border: 1px solid #ddd;
            padding: 0.5rem;
        }

        .word-content img {
            max-width: 100%;
            height: auto;
        }

        /* Excel Display */
        .excel-container {
            margin-top: 1rem;
        }

        .excel-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .excel-tab {
            padding: 0.5rem 1rem;
            background: #e8e8e8;
            border: none;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .excel-tab.active {
            background: #4CAF50;
            color: white;
        }

        .excel-content {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow-x: auto;
            max-height: 70vh;
            overflow-y: auto;
        }

        .excel-content table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .excel-content th,
        .excel-content td {
            border: 1px solid #ddd;
            padding: 0.4rem 0.6rem;
            text-align: left;
            white-space: nowrap;
        }

        .excel-content th {
            background: #f5f5f5;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .excel-content tr:nth-child(even) {
            background: #fafafa;
        }

        /* PowerPoint Display */
        .ppt-container {
            margin-top: 1rem;
        }

        .ppt-viewer {
            width: 100%;
            height: 80vh;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #f5f5f5;
        }

        /* CSV Display (uses excel styles) */
        .csv-container {
            margin-top: 1rem;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .sidebar {
                position: relative;
                width: 100%;
                height: auto;
                padding: 2rem 1.5rem 1rem;
            }

            .social-links {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
            }

            .social-links a,
            .social-links .orcid-link {
                width: auto;
                padding: 0.5rem;
                font-size: 0;
                gap: 0;
            }

            .social-links svg {
                width: 24px;
                height: 24px;
            }

            .social-links .hide-mobile {
                display: none;
            }

            .sidebar-footer {
                margin-top: 1rem;
            }

            .content {
                margin-left: 0;
                padding: 2rem 1rem;
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                padding: 1.5rem 1rem 1rem;
            }

            .avatar {
                width: 80px;
                height: 80px;
            }

            h1 {
                font-size: 1.4rem;
            }

            article h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>

<body>

    <div class="layout">
        <aside class="sidebar" id="sidebar-content"></aside>
        <script src="/components/sidebar.js?v=20260128"></script>

        <main class="content">
            <a href="/blog/" class="back-link">â† Back to Blog</a>

            <!-- Language Selector -->
            <div class="lang-selector" id="lang-selector" style="display: none;">
                <span class="lang-selector-label">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
                    </svg>
                    Language
                </span>
                <select class="lang-select" id="lang-select">
                    <option value="en">ğŸ‡ºğŸ‡¸ English</option>
                    <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
                    <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                    <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
                    <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
                    <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
                    <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
                    <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
                    <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                    <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                </select>
                <button class="lang-original-btn" id="lang-original-btn" style="display: none;">Show Original</button>
                <span class="lang-status" id="lang-status"></span>
            </div>

            <article>
<hr>
<h2>date: 2026-01-28
tags: [ai, rag, cloudflare-workers, javascript, llm]
description: Building a RAG-powered AI assistant for my personal website using hybrid search, Cloudflare Workers, and OpenAI API.</h2>
<h1>Building a RAG-Powered AI Assistant for My Personal Website</h1>
<p>I recently added an AI chat assistant to my personal website that can answer questions about my blog posts, projects, and background. This post documents the implementation journey, from architecture design to security considerations.</p>
<h2>The Goal</h2>
<p>Create a floating chat widget that:</p>
<ul>
<li>Answers questions about blog content using RAG (Retrieval-Augmented Generation)</li>
<li>Provides friendly technical discussions</li>
<li>Handles sensitive topics gracefully</li>
<li>Works entirely on static hosting (GitHub Pages) with Cloudflare Workers as the API layer</li>
</ul>
<h2>Architecture Overview</h2>
<pre><code><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚                        Browser (Frontend)                        â”‚</span>
<span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="line">â”‚  Chat Widget â”€â”€â”€â”€â”€â”€â–¶ Search Client                              â”‚</span>
<span class="line">â”‚       â”‚              â”œâ”€ BM25 Keyword Search (local)             â”‚</span>
<span class="line">â”‚       â”‚              â””â”€ Voy WASM Semantic Search                â”‚</span>
<span class="line">â”‚       â”‚                        â”‚                                â”‚</span>
<span class="line">â”‚       â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ (Top 3 chunks as context)      â”‚</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line">        â”‚ POST /api/chat { messages, context }</span>
<span class="line">        â–¼</span>
<span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚              Cloudflare Worker (yuxu.ge/api/*)                  â”‚</span>
<span class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚</span>
<span class="line">â”‚  â”‚ /api/embedding  â”‚        â”‚   /api/chat     â”‚                 â”‚</span>
<span class="line">â”‚  â”‚ (query vector)  â”‚        â”‚ system_prompt   â”‚                 â”‚</span>
<span class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ + RAG context   â”‚                 â”‚</span>
<span class="line">â”‚           â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="line">            â”‚                          â”‚</span>
<span class="line">            â–¼                          â–¼</span>
<span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="line">â”‚                         OpenAI API                              â”‚</span>
<span class="line">â”‚  text-embedding-3-small (512d)    gpt-4o-mini                   â”‚</span>
<span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></code></pre>
<h2>Implementation</h2>
<h3>1. Chat Widget (Frontend)</h3>
<p>The chat widget is a self-contained JavaScript module that creates a floating bubble UI:</p>
<pre><code class="language-javascript"><span class="line">export class ChatWidget {</span>
<span class="line">    constructor() {</span>
<span class="line">        this.messages = [];</span>
<span class="line">        this.isOpen = false;</span>
<span class="line">        this.searchClient = null;</span>
<span class="line">    }</span>
<span class="line"></span>
<span class="line">    async sendMessage(text) {</span>
<span class="line">        // Get RAG context from search client</span>
<span class="line">        let context = &#39;&#39;;</span>
<span class="line">        if (this.searchClient?.isReady()) {</span>
<span class="line">            const results = await this.searchClient.search(text, 3);</span>
<span class="line">            context = results.map(r =&gt; `[${r.title}]\n${r.text}`).join(&#39;\n\n&#39;);</span>
<span class="line">        }</span>
<span class="line"></span>
<span class="line">        // Call chat API with context</span>
<span class="line">        const response = await fetch(&#39;https://yuxu.ge/api/chat&#39;, {</span>
<span class="line">            method: &#39;POST&#39;,</span>
<span class="line">            headers: { &#39;Content-Type&#39;: &#39;application/json&#39; },</span>
<span class="line">            body: JSON.stringify({</span>
<span class="line">                messages: this.messages,</span>
<span class="line">                context,</span>
<span class="line">            }),</span>
<span class="line">        });</span>
<span class="line"></span>
<span class="line">        const data = await response.json();</span>
<span class="line">        return data.reply;</span>
<span class="line">    }</span>
<span class="line">}</span></code></pre>
<p>Key features:</p>
<ul>
<li><strong>Markdown rendering</strong>: Converts <code>**bold**</code> and <code>[links](url)</code> to HTML</li>
<li><strong>CSS-in-JS</strong>: All styles are injected dynamically, no external dependencies</li>
<li><strong>ESC to close</strong>: Keyboard accessibility</li>
<li><strong>Mobile responsive</strong>: Adapts to screen size</li>
</ul>
<h3>2. Hybrid Search for RAG</h3>
<p>I already had a search system built with:</p>
<ul>
<li><strong>BM25 keyword search</strong>: Local inverted index for exact term matching</li>
<li><strong>Voy WASM semantic search</strong>: Vector similarity using pre-computed embeddings</li>
<li><strong>RRF fusion</strong>: Combines both results using Reciprocal Rank Fusion</li>
</ul>
<p>The chat widget reuses this existing infrastructure:</p>
<pre><code class="language-javascript"><span class="line">const [keywordResults, semanticResults] = await Promise.all([</span>
<span class="line">    this.keywordSearch(query, limit * 2),</span>
<span class="line">    this.semanticSearch(query, limit * 2),</span>
<span class="line">]);</span>
<span class="line"></span>
<span class="line">// Merge using RRF</span>
<span class="line">for (const result of keywordResults) {</span>
<span class="line">    rrfScores[result.url] = keywordWeight / (k + result.rank);</span>
<span class="line">}</span>
<span class="line">for (const result of semanticResults) {</span>
<span class="line">    rrfScores[result.url] += semanticWeight / (k + result.rank);</span>
<span class="line">}</span></code></pre>
<h3>3. Cloudflare Worker (API Proxy)</h3>
<p>The Worker handles two endpoints:</p>
<p><strong><code>/api/embedding</code></strong> - Converts query text to vector for semantic search:</p>
<pre><code class="language-javascript"><span class="line">const response = await fetch(&#39;https://api.openai.com/v1/embeddings&#39;, {</span>
<span class="line">    method: &#39;POST&#39;,</span>
<span class="line">    headers: {</span>
<span class="line">        &#39;Authorization&#39;: `Bearer ${env.OPENAI_API_KEY}`,</span>
<span class="line">        &#39;Content-Type&#39;: &#39;application/json&#39;,</span>
<span class="line">    },</span>
<span class="line">    body: JSON.stringify({</span>
<span class="line">        model: &#39;text-embedding-3-small&#39;,</span>
<span class="line">        input: text,</span>
<span class="line">        dimensions: 512,</span>
<span class="line">    }),</span>
<span class="line">});</span></code></pre>
<p><strong><code>/api/chat</code></strong> - Chat completion with RAG context:</p>
<pre><code class="language-javascript"><span class="line">const systemMessage = context</span>
<span class="line">    ? `${env.system_prompt}\n\n## Related blog content:\n${context}`</span>
<span class="line">    : env.system_prompt;</span>
<span class="line"></span>
<span class="line">const response = await fetch(&#39;https://api.openai.com/v1/chat/completions&#39;, {</span>
<span class="line">    method: &#39;POST&#39;,</span>
<span class="line">    headers: { &#39;Authorization&#39;: `Bearer ${env.OPENAI_API_KEY}` },</span>
<span class="line">    body: JSON.stringify({</span>
<span class="line">        model: &#39;gpt-4o-mini&#39;,</span>
<span class="line">        messages: [</span>
<span class="line">            { role: &#39;system&#39;, content: systemMessage },</span>
<span class="line">            ...messages,</span>
<span class="line">        ],</span>
<span class="line">    }),</span>
<span class="line">});</span></code></pre>
<h3>4. Security: Handling Sensitive Topics</h3>
<p>For a personal website, I needed the assistant to:</p>
<ul>
<li>Freely discuss the website owner (me)</li>
<li>Refuse political/sensitive topics gracefully</li>
</ul>
<p>This is handled in the system prompt (stored as environment variable):</p>
<pre><code><span class="line">## About the website owner</span>
<span class="line">Yuxu Ge is the website owner. You can freely discuss:</span>
<span class="line">- Professional background, technical experience, projects</span>
<span class="line">- Blog content, technical opinions</span>
<span class="line">- Public information (education, work history)</span>
<span class="line"></span>
<span class="line">## Conversation boundaries</span>
<span class="line">Politely decline and redirect for:</span>
<span class="line">- Political figures, government policies, geopolitical disputes</span>
<span class="line">- Religious or ideological debates</span>
<span class="line"></span>
<span class="line">When declining: &quot;This is beyond my scope as a technical assistant.</span>
<span class="line">Shall we discuss something technical instead?&quot;</span>
<span class="line"></span>
<span class="line">## Public contact info (can share)</span>
<span class="line">- Email: me@yuxu.ge</span>
<span class="line">- GitHub: https://github.com/geyuxu</span>
<span class="line">- LinkedIn: https://linkedin.com/in/yuxuge</span></code></pre>
<h3>5. Conversation History with localStorage</h3>
<p>For better UX, the chat widget persists conversation history in the browser&#39;s localStorage:</p>
<pre><code class="language-javascript"><span class="line">const CHAT_CONFIG = {</span>
<span class="line">    storageKey: &#39;chat_history&#39;,</span>
<span class="line">    historyTTL: 24 * 60 * 60 * 1000, // 24 hours</span>
<span class="line">};</span>
<span class="line"></span>
<span class="line">// Save after each successful response</span>
<span class="line">saveHistory() {</span>
<span class="line">    const data = {</span>
<span class="line">        messages: this.messages.slice(-20),</span>
<span class="line">        timestamp: Date.now(),</span>
<span class="line">    };</span>
<span class="line">    localStorage.setItem(CHAT_CONFIG.storageKey, JSON.stringify(data));</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">// Load on widget initialization</span>
<span class="line">loadHistory() {</span>
<span class="line">    const raw = localStorage.getItem(CHAT_CONFIG.storageKey);</span>
<span class="line">    if (!raw) return;</span>
<span class="line"></span>
<span class="line">    const data = JSON.parse(raw);</span>
<span class="line"></span>
<span class="line">    // Check TTL expiration</span>
<span class="line">    if (Date.now() - data.timestamp &gt; CHAT_CONFIG.historyTTL) {</span>
<span class="line">        localStorage.removeItem(CHAT_CONFIG.storageKey);</span>
<span class="line">        return;</span>
<span class="line">    }</span>
<span class="line"></span>
<span class="line">    this.messages = data.messages;</span>
<span class="line">    this.renderHistory();</span>
<span class="line">}</span></code></pre>
<p>Features:</p>
<ul>
<li><strong>Auto-save</strong>: Saves after each assistant response</li>
<li><strong>Auto-restore</strong>: Restores conversation when page loads</li>
<li><strong>24-hour TTL</strong>: Automatically clears stale conversations</li>
<li><strong>Clear button</strong>: Manual clear via trash icon in header</li>
</ul>
<p>This is a pragmatic choice over server-side storage (Cloudflare KV) because:</p>
<ul>
<li>Most visitors have one-time conversations</li>
<li>No user identification needed</li>
<li>Zero additional cost</li>
<li>Simpler implementation</li>
</ul>
<h2>Lessons Learned</h2>
<ol>
<li><p><strong>Environment variables &gt; hardcoded prompts</strong>: Storing <code>system_prompt</code> as a Cloudflare environment variable allows prompt iteration without code deployment.</p>
</li>
<li><p><strong>Reuse existing search infrastructure</strong>: Building RAG on top of an existing hybrid search system saved significant effort.</p>
</li>
<li><p><strong>Nuanced content filtering</strong>: Initial attempts at sensitive topic filtering were too aggressive (blocking questions about myself). The key is explicitly whitelisting allowed topics.</p>
</li>
<li><p><strong>Markdown in chat</strong>: Simple regex-based markdown parsing is sufficient for bold and links. No need for heavy libraries.</p>
</li>
<li><p><strong>Start simple with state management</strong>: localStorage is sufficient for conversation history. Server-side storage (KV) adds complexity without clear benefit for a personal site.</p>
</li>
</ol>
<h2>Cost Analysis</h2>
<p>With <code>gpt-4o-mini</code> and <code>text-embedding-3-small</code>:</p>
<ul>
<li>Embedding: ~$0.00002 per query</li>
<li>Chat: ~$0.0001-0.0005 per response (depending on context length)</li>
<li>Estimated monthly cost: &lt; $5 for moderate traffic</li>
</ul>
<h2>Next Steps</h2>
<ul>
<li><input disabled="" type="checkbox"> Add streaming responses for better UX</li>
<li><input checked="" disabled="" type="checkbox"> <del>Implement conversation memory</del> (Done with localStorage)</li>
<li><input disabled="" type="checkbox"> Add usage analytics</li>
<li><input disabled="" type="checkbox"> Support image understanding for blog screenshots</li>
</ul>
<p>The complete implementation is open source in my website repository. Feel free to adapt it for your own projects!</p>

    </article>
    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/prismjs@1/prism.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-python.min.js"></script>
<script>
Prism.highlightAll();
document.querySelectorAll('article pre').forEach(pre => {
    const code = pre.querySelector('code');
    if (!code) return;
    const toolbar = document.createElement('div');
    toolbar.className = 'code-toolbar';
    const btn = document.createElement('button');
    btn.className = 'copy-btn';
    btn.textContent = 'Copy';
    btn.onclick = () => {
        navigator.clipboard.writeText(code.textContent).then(() => {
            btn.textContent = 'Copied!';
            btn.classList.add('copied');
            setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
        });
    };
    toolbar.appendChild(btn);
    pre.parentNode.insertBefore(toolbar, pre);
});
</script>
</body>
</html>